name: Deploy to VPS via SSH
on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-vps-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SSH_PORT: ${{ secrets.SSH_PORT }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      PM2_PROCESS_NAME: ${{ secrets.PM2_PROCESS_NAME }}
      SYSTEMD_SERVICE_NAME: ${{ secrets.SYSTEMD_SERVICE_NAME }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps and build (local)
        run: |
          npm ci
          npm run build --if-present

      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          touch ~/.ssh/known_hosts
          # если SSH_PORT пустой, ssh-keyscan без -p
          if [ -n "${SSH_PORT:-}" ]; then
            ssh-keyscan -H -p "${SSH_PORT}" "${SSH_HOST}" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "${SSH_HOST}" >> ~/.ssh/known_hosts
          fi
          chmod 600 ~/.ssh/known_hosts

      - name: Rsync to server
        env:
          RSYNC_RSH: "ssh -p ${SSH_PORT:-22} -o StrictHostKeyChecking=no"
        run: |
          rsync -az --delete \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='node_modules' \
            --exclude='.github' \
            --exclude='.gitlab-ci.yml' \
            ./ "${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}"

      - name: Remote deploy (install & restart)
        run: |
          ssh -p "${SSH_PORT:-22}" -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" bash -s -- "${DEPLOY_PATH}" "${PM2_PROCESS_NAME}" "${SYSTEMD_SERVICE_NAME}" <<'REMOTE_EOF'
          set -euo pipefail
          DEPLOY_PATH="$1"
          PM2_NAME="${2:-app}"
          SYSTEMD_NAME="${3:-app.service}"

          mkdir -p "$DEPLOY_PATH"
          cd "$DEPLOY_PATH"

          # Install production dependencies (tolerate failures if not applicable)
          npm ci --production --prefer-offline --no-audit || true

          # If you need to build on server, uncomment:
          # npm run build --if-present

          if command -v pm2 >/dev/null 2>&1; then
            if [ -f ecosystem.config.js ]; then
              pm2 startOrReload ecosystem
.config.js --env production || true
            fi
            pm2 restart "$PM2_NAME" || pm2 start npm --name "$PM2_NAME" -- start || true
          else
            sudo systemctl restart "$SYSTEMD_NAME" || true
          fi
          REMOTE_EOF
